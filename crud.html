<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>CRUD Videojuegos - Dark Mode</title>

    <!-- MATERIALIZE -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">

    <!-- ICONOS GOOGLE -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- DATATABLES -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">


    <style>
        /* ===== FONDO COMPLETO DEL CRUD ===== */
body {
    padding: 25px;
    color: #e0e6f0;
    /* Fondo con imagen + oscurecido */
    background:
        linear-gradient(rgba(0, 0, 0, 0.80), rgba(0, 0, 0, 0.80)),
        url("https://images7.alphacoders.com/134/thumb-1920-1347135.png");

    background-size: cover;
    background-position: center;
    background-attachment: fixed;
}

/* ===== TARJETAS MODO OSCURO ===== */
.card, .card-panel {
    background: rgba(20, 22, 30, 0.85) !important;
    color: #e0e6f0;
    border: 1px solid rgba(120, 20, 20, 0.6); /* rojo oscuro */
    backdrop-filter: blur(6px);
}

/* Títulos */
.card-title, h3 {
    color: #d10f1b; /* ROJO ITACHI */
}

/* Inputs */
.input-field input,
.input-field textarea {
    color: #e0e6f0;
}

.input-field label {
    color: #e79a9f !important; /* rojo suave apagado */
}

/* label activa y focus */
.input-field input:focus + label,
.input-field textarea:focus + label {
    color: #ff2a3b !important; /* rojo brillante */
}

.input-field input:focus,
.input-field textarea:focus {
    border-bottom: 1px solid #ff2a3b !important;
    box-shadow: 0 1px 0 0 #ff2a3b !important;
}

/* ===== BOTONES ===== */
.btn, .btn-small {
    background-color: #b30015 !important; /* rojo profundo */
}
.btn:hover, .btn-small:hover {
    background-color: #d6001a !important;
}

/* Botón rojo (delete) más oscuro estilo Akatsuki */
.red {
    background-color: #7a000a !important;
}
.red:hover {
    background-color: #a00012 !important;
}

/* ===== TABLA ===== */
table.dataTable {
    background: rgba(15, 18, 25, 0.8);
    color: #e0e6f0;
    backdrop-filter: blur(4px);
}

table.dataTable thead {
    background: rgba(10, 0, 0, 0.9);
}

table.dataTable thead th {
    color: #ff2a3b; /* rojo brillante */
    border-bottom: 2px solid #ff2a3b;
}

table.dataTable tbody tr {
    background: rgba(20, 10, 10, 0.75);
}

table.dataTable tbody tr:hover {
    background: rgba(40, 10, 10, 0.85);
}

/* ===== PAGINACIÓN ===== */
.dataTables_wrapper .dataTables_paginate .paginate_button {
    color: #ffffff !important;
}

.dataTables_wrapper .dataTables_paginate .paginate_button.current {
    background: #d10f1b !important;
    color: black !important;
}

    </style>
</head>

<body>

    <h3 class="center-align">CRUD de Videojuegos</h3>

    <!-- ===== FORMULARIO EN UNA CARD ===== -->
    <div class="card">
        <div class="card-content">
            <span class="card-title">Agregar / Editar</span>

            <form id="formCrud">

                <input type="hidden" id="idEditando">

                <div class="input-field">
                    <input id="nombre" type="text" required>
                    <label for="nombre">Nombre</label>
                </div>

                <div class="input-field">
                    <input id="estudio" type="text" required>
                    <label for="estudio">Estudio</label>
                </div>

                <div class="input-field">
                    <input id="genero" type="text" required>
                    <label for="genero">Género</label>
                </div>

                <div class="input-field">
                    <input id="anio" type="number" required>
                    <label for="anio">Año</label>
                </div>

                <div class="input-field">
                    <input id="puntuacion" type="number" required>
                    <label for="puntuacion">Puntuación</label>
                </div>

                <div class="input-field">
                    <input id="plataformas" type="text" required>
                    <label for="plataformas">Plataformas (separadas por coma)</label>
                </div>

                <div class="input-field">
                    <input id="imagen" type="text" required>
                    <label for="imagen">URL de Imagen</label>
                </div>

                <div class="input-field">
                    <input id="gameplay" type="text" required>
                    <label for="gameplay">URL de Gameplay</label>
                </div>

                <div class="input-field">
                    <textarea id="resumen" class="materialize-textarea" required></textarea>
                    <label for="resumen">Resumen</label>
                </div>

                <button type="submit" id="btnGuardar" class="btn waves-effect waves-light blue">
                    Agregar <i class="material-icons right">add</i>
                </button>

                <button type="button" id="btnCancelar" class="btn red" style="display:none;">
                    Cancelar
                </button>

            </form>
        </div>
    </div>

    <!-- ===== TABLA ===== -->
    <div class="card-panel">
        <table id="tablaCrud" class="display compact">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Estudio</th>
                    <th>Género</th>
                    <th>Año</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- ===== LIBRERÍAS ===== -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <!-- ===== FIREBASE + CRUD ===== -->
    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc }
            from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDL6rQZ26lv8-HEXlVJaW8Xwc42FCKxgkA",
            authDomain: "bibliotecavideojuegos-9ff72.firebaseapp.com",
            projectId: "bibliotecavideojuegos-9ff72",
            storageBucket: "bibliotecavideojuegos-9ff72.firebasestorage.app",
            messagingSenderId: "405804750018",
            appId: "1:405804750018:web:2af7fea6bd66e3b54b175b",
            measurementId: "G-333PHWPRED"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const coleccion = collection(db, "mibd");

        function mostrarToast(mensaje, tipo="success"){
            M.toast({ 
                html: mensaje, 
                classes: tipo === "error" ? "red darken-2" : "blue darken-2"
            });
        }

        let tabla;

        $(document).ready(() => {

            tabla = $('#tablaCrud').DataTable({
                data: [],
                columns: [
                    { data: "nombre" },
                    { data: "estudio" },
                    { data: "genero" },
                    { data: "anio" },
                    {
                        data: null,
                        render: row => `
                            <button class="btn-small blue btnEditar" data-id="${row.id}">
                                <i class="material-icons">edit</i>
                            </button>
                            <button class="btn-small red btnEliminar" data-id="${row.id}">
                                <i class="material-icons">delete</i>
                            </button>
                        `
                    }
                ]
            });

            cargarDatos();

            async function cargarDatos() {
                const snap = await getDocs(coleccion);
                const datos = snap.docs.map(docSnap => ({
                    id: docSnap.id,
                    ...docSnap.data()
                }));

                tabla.clear();
                tabla.rows.add(datos).draw();
            }

            const form = document.getElementById("formCrud");

            form.addEventListener("submit", async e => {
                e.preventDefault();

                const data = {
                    nombre: nombre.value,
                    estudio: estudio.value,
                    genero: genero.value,
                    anio: Number(anio.value),
                    puntuacion: Number(puntuacion.value),
                    plataformas: plataformas.value.split(",").map(x => x.trim()),
                    imagen: imagen.value,
                    gameplay: gameplay.value,
                    resumen: resumen.value
                };

                const id = idEditando.value;

                if (id) {
                    await updateDoc(doc(db, "mibd", id), data);
                    mostrarToast("Juego actualizado");
                } else {
                    await addDoc(coleccion, data);
                    mostrarToast("Juego agregado");
                }

                form.reset();
                idEditando.value = "";
                btnGuardar.textContent = "Agregar";
                btnCancelar.style.display = "none";

                cargarDatos();
                M.updateTextFields();
            });

            $('#tablaCrud tbody').on("click", ".btnEditar", function () {
                const data = tabla.row($(this).parents("tr")).data();

                idEditando.value = data.id;
                nombre.value = data.nombre;
                estudio.value = data.estudio;
                genero.value = data.genero;
                anio.value = data.anio;
                puntuacion.value = data.puntuacion;
                plataformas.value = data.plataformas.join(", ");
                imagen.value = data.imagen;
                gameplay.value = data.gameplay;
                resumen.value = data.resumen;

                M.updateTextFields();

                btnGuardar.textContent = "Actualizar";
                btnCancelar.style.display = "inline-block";
            });

            btnCancelar.onclick = () => {
                form.reset();
                idEditando.value = "";
                btnGuardar.textContent = "Agregar";
                btnCancelar.style.display = "none";
                M.updateTextFields();
            };

            $('#tablaCrud tbody').on("click", ".btnEliminar", async function () {
                const id = $(this).data("id");

                if (confirm("¿Seguro que quieres eliminar?")) {
                    await deleteDoc(doc(db, "mibd", id));
                    cargarDatos();
                    mostrarToast("Juego eliminado");
                }
            });

        });
    </script>
    <button onclick="window.location.href='index.html'" 
        style="margin-top:20px; padding:10px 20px; font-size:16px;">
        VOLVER A LA BIBLIOTECA
    </button>
</body>
</html>
